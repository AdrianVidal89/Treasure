{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Treasure{% endblock %}
{% block body_class %}dashboard-background{% endblock %}


{% block content %}

<div class="dashboard-container">  
    <div class="total-patrimonio-widget">
        <div class="mini-title">ğŸ§® Patrimonio Neto</div>
        <div class="total-patrimonio-titulo"></div>
        <div class="total-patrimonio-valor" id="valor-patrimonio-total">â‚¬0.00</div>
    </div>
</div>
  
<div class="dashboard-container">  

    <!-- TÃ­tulo fila de activos -->
    <h3 class="section-title">ğŸ’š Activos</h3>
    <div class="mini-dashboard-row">
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ’° LÃ­quido</div>
        <div class="mini-valor-real" id="valor-liquido">â‚¬0.00</div>
        <div class="mini-variacion" id="label-liquido">+0%</div>
        <canvas id="bar-liquido" height="60"></canvas>
      </div>
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ¡ Propiedades</div>
        <div class="mini-valor-real" id="valor-activos">â‚¬0.00</div>
        <div class="mini-variacion" id="label-activos">+0%</div>
        <canvas id="bar-activos" height="60"></canvas>
      </div>
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ“ˆ Inversiones</div>
        <div class="mini-valor-real" id="valor-inversiones">â‚¬0.00</div>
        <div class="mini-variacion" id="label-inversiones">+0%</div>
        <canvas id="bar-inversiones" height="60"></canvas>
      </div>
    </div>
  
    <!-- TÃ­tulo fila de pasivos -->
    <h3 class="section-title">ğŸ”» Pasivos</h3>
    <div class="mini-dashboard-row">
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ’³ CrÃ©ditos</div>
        <div class="mini-valor-real" id="valor-creditos">â‚¬0.00</div>
        <div class="mini-variacion" id="label-creditos">+0%</div>
        <canvas id="bar-creditos" height="60"></canvas>
      </div>
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ¦ PrÃ©stamos</div>
        <div class="mini-valor-real" id="valor-prestamos">â‚¬0.00</div>
        <div class="mini-variacion" id="label-prestamos">+0%</div>
        <canvas id="bar-prestamos" height="60"></canvas>
      </div>
      <div class="mini-dashboard">
        <div class="mini-title">ğŸ’· Hipotecas</div>
        <div class="mini-valor-real" id="valor-hipotecas">â‚¬0.00</div>
        <div class="mini-variacion" id="label-hipotecas">+0%</div>
        <canvas id="bar-hipotecas" height="60"></canvas>
      </div>
    </div>
  
    <!-- SecciÃ³n del grÃ¡fico -->
    <div class="chart-section">
      <h2>ğŸ“Š GrÃ¡fico de EvoluciÃ³n</h2>
      <div class="chart-controls">
        <fieldset class="filtro-checkboxes">
          <legend>CategorÃ­as:</legend>
          <label class="checkbox-label">
            <input type="checkbox" name="categoria" value="total">
            Patrimonio Total
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="categoria" value="liquido">
            Capital LÃ­quido
          </label>
          <label class="checkbox-label">
            <input type="checkbox" name="categoria" value="inversiones">
            Inversiones
          </label>
        </fieldset>
  
        <label for="filtro-periodo">Periodo:</label>
        <select id="filtro-periodo" class="cyber-select">
          <option value="6">Ãšltimos 6 meses</option>
          <option value="12" selected>Ãšltimos 12 meses</option>
          <option value="24">Ãšltimos 24 meses</option>
          <option value="todos">Todo el historial</option>
        </select>
      </div>
      <canvas id="grafico-evolucion" height="120"></canvas>
    </div>
  </div>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  datos.forEach(({ id, actual, anterior, moneda }) => {
    const delta = actual - anterior;
    const porcentaje = anterior !== 0 ? (delta / Math.abs(anterior)) * 100 : 0;
    const color = porcentaje > 0 ? '#00ff99' : porcentaje < 0 ? '#ff4d4d' : '#888';
    const ctx = document.getElementById(`bar-${id}`).getContext('2d');
    const etiqueta = document.getElementById(`label-${id}`);
    const valorReal = document.getElementById(`valor-${id}`);

    etiqueta.textContent = `${porcentaje > 0 ? '+' : ''}${porcentaje.toFixed(1)}%`;
    etiqueta.style.color = color;
    valorReal.textContent = `${moneda}${actual.toLocaleString()}`;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [''],
        datasets: [{
          data: [Math.abs(porcentaje)],
          backgroundColor: color,
          borderRadius: 6,
          barPercentage: 0.7
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        scales: {
          x: {
            min: 0,
            max: 100,
            ticks: { display: false },
            grid: { display: false }
          },
          y: {
            ticks: { display: false },
            grid: { display: false }
          }
        }
      }
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('grafico-evolucion').getContext('2d');
    const periodoSelect = document.getElementById('filtro-periodo');
    const categoriaCheckboxes = document.querySelectorAll('input[name="categoria"]');
    let chart;

    // ğŸ” Restaurar selecciÃ³n desde localStorage
    if (localStorage.getItem("periodo")) {
        periodoSelect.value = localStorage.getItem("periodo");
    }

    categoriaCheckboxes.forEach(cb => {
        const key = `categoria_${cb.value}`;
        if (localStorage.getItem(key) === "true") {
            cb.checked = true;
        }
    });

    // ğŸ§  Guardar selecciÃ³n al cambiar
    periodoSelect.addEventListener("change", function () {
        localStorage.setItem("periodo", this.value);
    });

    categoriaCheckboxes.forEach(cb => {
        cb.addEventListener("change", function () {
            localStorage.setItem(`categoria_${this.value}`, this.checked);
        });
    });

    function obtenerCategoriasSeleccionadas() {
        return Array.from(document.querySelectorAll('input[name="categoria"]:checked')).map(c => c.value);
    }

    function cargarDatos() {
    const categorias = obtenerCategoriasSeleccionadas();
    const periodo = periodoSelect.value;

    const params = new URLSearchParams();
    categorias.forEach(cat => params.append('categorias[]', cat));
    params.append('periodo', periodo);

    fetch(`/ui/dashboard/datos-evolucion/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            const colores = {
                total: '#00ffcc',
                liquido: '#00bfff',
                inversiones: '#ff00cc'
            };

            // 1. GrÃ¡fico de evoluciÃ³n
            const datasets = Object.entries(data.series).map(([key, valores]) => ({
                label: key === 'total' ? 'Patrimonio Total'
                      : key === 'liquido' ? 'Capital LÃ­quido'
                      : 'Inversiones',
                data: valores,
                borderColor: colores[key],
                backgroundColor: 'rgba(0, 0, 0, 0.05)',
                tension: 0.3,
                fill: false,
                pointRadius: 3,
                pointBackgroundColor: colores[key]
            }));

            if (chart) {
                chart.data.labels = data.labels;
                chart.data.datasets = datasets;
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#eaeaea' }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#aaa' },
                                grid: { color: '#333' }
                            },
                            y: {
                                ticks: { color: '#aaa' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });
            }

            // 2. Actualizar mini-dashboard con resumen_actual
            const resumen = data.resumen_actual;
            const widgets = [
                { id: 'liquido', data: resumen.liquido, color: '#00ff99' },
                { id: 'creditos', data: resumen.creditos, color: '#ff4d4d' },
                { id: 'activos', data: resumen.activos, color: '#ffaa00' },
                { id: 'inversiones', data: resumen.inversiones, color: '#b266ff' }
            ];

            widgets.forEach(({ id, data, color }) => {
                const delta = data.actual - data.anterior;
                const pct = data.anterior !== 0 ? (delta / Math.abs(data.anterior)) * 100 : 0;

                let colorFinal;
                if (id === 'creditos') {
                    colorFinal = pct > 0 ? '#ff4d4d' : pct < 0 ? '#00ff99' : '#888';  // lÃ³gica invertida
                } else {
                    colorFinal = pct > 0 ? '#00ff99' : pct < 0 ? '#ff4d4d' : '#888';
                }

                // texto real + variaciÃ³n %
                document.getElementById(`valor-${id}`).textContent = `â‚¬${data.actual.toLocaleString()}`;
                const label = document.getElementById(`label-${id}`);
                label.textContent = `${pct > 0 ? '+' : ''}${pct.toFixed(1)}%`;
                label.style.color = colorFinal;

                // redibujar el canvas
                const ctxWidget = document.getElementById(`bar-${id}`).getContext('2d');
                new Chart(ctxWidget, {
                    type: 'bar',
                    data: {
                        labels: [''],
                        datasets: [{
                            data: [Math.abs(pct)],
                            backgroundColor: colorFinal,
                            borderRadius: 6,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: 100,
                                ticks: { display: false },
                                grid: { display: false }
                            },
                            y: {
                                ticks: { display: false },
                                grid: { display: false }
                            }
                        }
                    }
                });
            });
        });
}

    // ğŸ” Inicializar grÃ¡fico despuÃ©s de restaurar filtros
    cargarDatos();

    // Escuchar cambios en filtros
    periodoSelect.addEventListener('change', cargarDatos);
    categoriaCheckboxes.forEach(cb => {
        cb.addEventListener('change', cargarDatos);
    });
});
</script>
{% endblock %}

